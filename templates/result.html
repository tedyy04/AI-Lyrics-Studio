<!DOCTYPE html>
<html lang="en">
  <head>
    <title>AI Audio Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body class="p-4 md:p-8 flex items-center justify-center">
    <div class="liquid-background-container">
        <div class="liquid-blob blob-1"></div>
        <div class="liquid-blob blob-2"></div>
        <div class="liquid-blob blob-3"></div>
    </div>
    <a
      href="/"
      class="absolute top-6 left-6 flex items-center gap-2 text-[#F7BFD8] hover:text-white transition-colors group z-50"
    >
      <div
        class="p-2 bg-[#203061]/50 rounded-full group-hover:bg-[#F880B0] transition-colors"
      >
        <i data-lucide="arrow-left" class="w-5 h-5 group-hover:text-white"></i>
      </div>
      <span class="font-bold text-sm hidden md:inline">Upload New File</span>
    </a>
    <div
      class="w-full max-w-6xl h-[90vh] grid grid-cols-1 md:grid-cols-12 gap-6"
    >
      <div class="md:col-span-5 flex flex-col gap-6 h-full">
        <div
          class="glass-panel rounded-[24px] p-8 flex flex-col justify-center items-center relative shadow-2xl flex-1"
        >
          <div
            class="w-48 h-48 rounded-lg shadow-lg mb-6 bg-gradient-to-br from-[#F880B0] to-[#57487F] flex items-center justify-center"
          >
            <i data-lucide="music" class="w-16 h-16 text-white opacity-50"></i>
          </div>

          <div class="text-center w-full mb-6">
            <h2 class="text-2xl font-bold truncate px-4" id="trackTitle">
              Processing...
            </h2>
            <p class="text-[#F7BFD8] text-sm mt-1" id="trackSubtitle">
              AI is working on your file
            </p>
            <div
              id="statusBadge"
              class="mt-3 inline-block px-3 py-1 rounded-full text-xs bg-[#203061] text-[#F7BFD8] animate-pulse"
            >
              Connecting...
            </div>
          </div>

          <div
            class="w-full space-y-2 opacity-50 pointer-events-none transition-opacity duration-500"
            id="playerControls"
          >
            <div class="relative w-full group">
              <input
                type="range"
                id="progressBar"
                value="0"
                step="0.1"
                class="w-full z-10 relative"
                oninput="seekAudio()"
              />
              <div
                id="segmentsMarkers"
                class="absolute top-1 left-0 w-full h-1 pointer-events-none"
              ></div>
            </div>
            <div class="flex justify-between text-xs text-[#F7BFD8] font-mono">
              <span id="currTime">00:00</span>
              <span id="totalTime">00:00</span>
            </div>

            <div class="flex justify-center items-center gap-6 mt-4">
              <button
                class="text-[#F7BFD8] hover:text-white"
                onclick="skip(-10)"
              >
                <i data-lucide="rotate-ccw"></i>
              </button>
              <button
                id="playBtn"
                onclick="togglePlay()"
                class="w-14 h-14 bg-[#F880B0] rounded-full flex items-center justify-center text-white shadow-lg hover:bg-[#F7BFD8] hover:scale-105 transition"
              >
                <i data-lucide="play" fill="currentColor"></i>
              </button>
              <button
                class="text-[#F7BFD8] hover:text-white"
                onclick="skip(10)"
              >
                <i data-lucide="rotate-cw"></i>
              </button>
            </div>
          </div>

          <audio id="audioEl" class="hidden"></audio>
        </div>

        <div
          class="glass-panel rounded-[24px] p-6 hidden transition-all duration-500"
          id="downloadCard"
        >
          <h3
            class="text-[#F7BFD8] font-bold text-sm uppercase mb-4 tracking-wider"
          >
            Downloads
          </h3>
          <div class="grid grid-cols-2 gap-3">
            <a
              href="#"
              onclick="downloadFile('txt')"
              class="bg-[#203061] hover:bg-[#57487F] text-center py-2 rounded-lg text-sm text-white transition"
              >TXT</a
            >
            <a
              href="#"
              onclick="downloadFile('srt')"
              class="bg-[#203061] hover:bg-[#57487F] text-center py-2 rounded-lg text-sm text-white transition"
              >SRT</a
            >
            <a
              href="#"
              onclick="downloadFile('vtt')"
              class="bg-[#203061] hover:bg-[#57487F] text-center py-2 rounded-lg text-sm text-white transition"
              >VTT</a
            >
            <a
              href="#"
              onclick="downloadFile('lrc')"
              class="bg-[#203061] hover:bg-[#57487F] text-center py-2 rounded-lg text-sm text-white transition"
              >LRC</a
            >
          </div>
        </div>
      </div>

      <div
        class="md:col-span-7 glass-panel rounded-[24px] overflow-hidden flex flex-col relative h-full"
      >
        <div
          class="p-4 border-b border-white/10 flex justify-between items-center bg-[#203061]/40"
        >
          <h3 class="font-bold">Transcript</h3>
          <label class="flex items-center space-x-2 text-xs cursor-pointer">
            <input
              type="checkbox"
              id="autoScroll"
              checked
              class="accent-[#F880B0]"
            />
            <span class="text-[#F7BFD8]">Auto-scroll</span>
          </label>
        </div>

        <div
          id="lyricsContent"
          class="lyrics-container flex-1 overflow-y-auto p-4 space-y-1 relative"
        >
          <div class="animate-pulse space-y-4 mt-10 px-4">
            <div class="h-4 bg-[#57487F] rounded w-3/4"></div>
            <div class="h-4 bg-[#57487F] rounded w-1/2"></div>
            <div class="h-4 bg-[#57487F] rounded w-5/6"></div>
          </div>
          <div class="text-center text-[#F7BFD8] mt-4 text-sm animate-pulse">
            Waiting for magic...
          </div>
        </div>
      </div>
    </div>

    <script>
      lucide.createIcons();
      const jobId = "{{ job_id }}";
      const audio = document.getElementById("audioEl");
      const lyricsDiv = document.getElementById("lyricsContent");
      let segments = [];
      let pollingInterval;

      // --- POLLING STATUS ---
      async function checkStatus() {
        try {
          const res = await fetch(`/api/status/${jobId}`);
          if (!res.ok) return;
          const data = await res.json();

          const badge = document.getElementById("statusBadge");

          if (data.status === "error") {
            badge.innerText = "Error";
            badge.classList.remove("animate-pulse");
            badge.classList.add("bg-red-500");
            alert("Error: " + data.error);
            clearInterval(pollingInterval);
          } else if (data.status === "done") {
            clearInterval(pollingInterval);
            badge.innerText = "Ready";
            badge.classList.remove("animate-pulse", "bg-[#203061]");
            badge.classList.add("bg-[#F880B0]", "text-[#203061]", "font-bold");

            initPlayer(data);
          } else {
            // Update texts like "Separating vocals..."
            let label =
              data.status === "pending"
                ? "Queued..."
                : data.status === "separating"
                ? "Separating Vocals..."
                : "Transcribing...";
            badge.innerText = label;
          }
        } catch (e) {
          console.error(e);
        }
      }

      pollingInterval = setInterval(checkStatus, 2000);
      checkStatus(); // First check immediately

      // --- PLAYER INIT ---
      function initPlayer(data) {
        document.getElementById("trackTitle").innerText = data.original_name;
        document.getElementById("trackSubtitle").innerText =
          "Demucs + Whisper v3";
        document.getElementById("downloadCard").classList.remove("hidden");

        // Enable Player
        const controls = document.getElementById("playerControls");
        controls.classList.remove("opacity-50", "pointer-events-none");

        // Set Audio
        audio.src = `/stream/${jobId}`;
        segments = data.segments;

        // Render Lyrics
        renderLyrics(segments);

        // Render Highlights Markers on Timeline
        renderMarkers(data.highlights, data.duration);
      }

      // --- RENDER FUNCTIONS ---
      function renderLyrics(segs) {
        lyricsDiv.innerHTML = "";
        segs.forEach((seg, index) => {
          const div = document.createElement("div");
          div.className =
            "lyric-line p-3 rounded-lg cursor-pointer text-gray-200 text-lg leading-relaxed";
          div.dataset.start = seg.start;
          div.dataset.index = index;
          div.onclick = () => {
            audio.currentTime = seg.start;
            audio.play();
            updatePlayBtn(true);
          };

          const timeStr = formatTime(seg.start);
          div.innerHTML = `<span class="text-xs text-[#F880B0] font-mono mr-3 opacity-70 select-none">${timeStr}</span>${seg.text}`;
          lyricsDiv.appendChild(div);
        });
      }

      function renderMarkers(highlights, duration) {
        const container = document.getElementById("segmentsMarkers");
        if (!highlights) return;
        highlights.forEach((h) => {
          const left = (h.start / duration) * 100;
          const dot = document.createElement("div");
          dot.style.left = `${left}%`;
          dot.className =
            "absolute top-0 w-1.5 h-1.5 bg-[#F7BFD8] rounded-full shadow shadow-white transform -translate-x-1/2";
          container.appendChild(dot);
        });
      }

      // --- AUDIO CONTROLS ---
      function togglePlay() {
        if (audio.paused) {
          audio.play();
        } else {
          audio.pause();
        }
      }

      function updatePlayBtn(isPlaying) {
        const btn = document.getElementById("playBtn");
        btn.innerHTML = isPlaying
          ? `<i data-lucide="pause" fill="currentColor"></i>`
          : `<i data-lucide="play" fill="currentColor"></i>`;
        lucide.createIcons();
      }

      audio.onplay = () => updatePlayBtn(true);
      audio.onpause = () => updatePlayBtn(false);

      audio.ontimeupdate = () => {
        const curr = audio.currentTime;
        const dur = audio.duration || 1;

        // Update Text & Slider
        document.getElementById("currTime").innerText = formatTime(curr);
        document.getElementById("progressBar").value = (curr / dur) * 100;

        // Sync Lyrics
        syncLyrics(curr);
      };

      audio.onloadedmetadata = () => {
        document.getElementById("totalTime").innerText = formatTime(
          audio.duration
        );
      };

      function seekAudio() {
        const val = document.getElementById("progressBar").value;
        const time = (val / 100) * audio.duration;
        audio.currentTime = time;
      }

      function skip(sec) {
        audio.currentTime += sec;
      }

      // --- LYRIC SYNC LOGIC ---
      function syncLyrics(time) {
        // Find current segment
        const currentIdx = segments.findIndex(
          (s) => time >= s.start && time <= s.end
        );

        // Remove active class from all
        document
          .querySelectorAll(".lyric-line")
          .forEach((el) => el.classList.remove("active"));

        if (currentIdx !== -1) {
          const activeEl = lyricsDiv.children[currentIdx];
          activeEl.classList.add("active");

          if (document.getElementById("autoScroll").checked) {
            activeEl.scrollIntoView({ behavior: "smooth", block: "center" });
          }
        }
      }

      // --- UTILS ---
      function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m < 10 ? "0" + m : m}:${s < 10 ? "0" + s : s}`;
      }

      function downloadFile(fmt) {
        window.location.href = `/download/${jobId}/${fmt}`;
      }
    </script>
  </body>
</html>
